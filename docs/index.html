<!--Skygear CDN-->
<script src="https://code.skygear.io/js/polyfill/latest/polyfill.min.js"></script>
<script src="https://code.skygear.io/js/skygear/latest/skygear.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>

<!--Skygear configuration-->
<!--The app end point and the api key can be found in the developer portal-->
<script>
  var config = {
    apiKey: "AIzaSyDeXslekRSxKlQzvdS3b908i18s1Ztg5ak",
    authDomain: "corner-ch.firebaseapp.com",
    databaseURL: "https://corner-ch.firebaseio.com",
    projectId: "corner-ch",
    storageBucket: "gs://corner-ch.appspot.com",
    messagingSenderId: "202391887409",

    rules: {
      ".read": true,
      ".write": true
    }

  };

  firebase.initializeApp(config);
  var database = firebase.database();
  var storage = firebase.storage();
  var storageRef = storage.ref();
  var login_user = false

  skygear.config({
    'endPoint': 'https://cornerch.skygeario.com/', // trailing slash is required
    'apiKey': '93e92fb17bce4768820d623c71ca7b6d',
  }).then(() => {
    console.log('skygear container is now ready for making API calls.');
  })

  var Login = (callback = null) => {
    let name = $('input#name')[0].value
    let pw = $('input#password')[0].value
    console.log('hi')
    skygear.auth.signupWithUsername(name, pw)
      .then((user) => {
        console.log(user)
        firebase.database().ref('users/' + name).set({
          username: name,
          marks: 0
        })

        LoginSuccess(name, callback)
      },
      (error) => {
        skygear.auth.loginWithUsername(name, pw)
          .then((user) => {
            console.log(user)
            LoginSuccess(name, callback)
          }, (error) => {
            console.error(error);
          })
      })
  }

  var LoginSuccess = (name, callback) => {
    skygear.pubsub.on(name, (data) => {
      FeedbackListener(data)
    });
    login_user = name
    if (callback) callback()
  }

  var Upload = () => {
    console.log('uploading...')
    if (!login_user) Login(Upload)
    else {
      let name = $('input#name')[0].value
      let cppfile = $('input#file')[0].files[0]

      var fileRef = storageRef.child(`files/${name}.cpp`);
      fileRef.put(cppfile).then(function (snapshot) {
        console.log('Uploaded a blob or file!');
        skygear.pubsub.publish('upload', name)
      });
    }
    tout = setTimeout(() => {
      alert('cannot connect to admin')
      clearTimeout(tout)
    }, 5000);
  }

  var FeedbackListener = (data) => {
    console.log(data)
    if(data == "received"){
      clearTimeout(tout)
      console.log('well received')
    }
  }

</script>

<p>name:
  <input type="text" id="name">
</p>
<p>password:
  <input type="password" id="password">
</p>
<p>
  <button id="login" onclick="Login()">login/sign up</button>
</p>

<p>Select your main.cpp:
  <input type="file" id="file" name="file" accept=".cpp">
</p>

<button id="upload" onclick="Upload()">Upload</button>