<!--Skygear CDN-->
<script src="https://code.skygear.io/js/polyfill/latest/polyfill.min.js"></script>
<script src="https://code.skygear.io/js/skygear/latest/skygear.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

<!--Skygear configuration-->
<!--The app end point and the api key can be found in the developer portal-->
<script>

  var is_login = false

  skygear.config({
    'endPoint': 'https://cornerch.skygeario.com/', // trailing slash is required
    'apiKey': '93e92fb17bce4768820d623c71ca7b6d',
  }).then(() => {

    console.log('skygear container is now ready for making API calls.');

    skygear.pubsub.on('feedback', (data) => {
      console.log(data);
    });
  })

  var Login = () => {
    let name = $('input#name')[0].value
    let pw = $('input#password')[0].value
    console.log('hi')
    skygear.auth.signupWithUsername(name, pw)
      .then((user) => {
        is_login = true
        console.log(user)
      },
      (error) => {
        console.log(error)
        skygear.auth.loginWithUsername(name, pw)
          .then((user) => {
            is_login = true
            console.log(user); // user object
          }, (error) => {
            console.error(error);
          })
      })
  }

  var Upload = () => {
    console.log('uploading...')
    if (!is_login) Login()

    let name = $('input#name')[0].value
    let cppfile = $('input#file')[0].files[0]
    const file = new skygear.Asset({
      name: name + ".cpp",
      file: cppfile,
    });

    const Note = skygear.Record.extend('note');

    const query = new skygear.Query(Note);
    query.equalTo('name', name)
    skygear.publicDB.query(query)
      .then((records) => {
        //not first time delete
        skygear.publicDB.delete({
          id: records[0].id
        }).then((record) => {
          console.log('deleted',record)
        }, (error) => {
          console.error(error)
        });

        //first upload create
        const note = new Note({ name: name, attachment: file });
        skygear.publicDB.save(note)
          .then((record) => {
            console.log(record.attachment.url)
            skygear.pubsub.publish('upload', name)
          }, (error) => {
            console.error(error)
          })

      })


  }
</script>

<p>name:
  <input type="text" id="name">
</p>
<p>password:
  <input type="password" id="password">
</p>
<p>
  <button id="login" onclick="Login()">login/sign up</button>
</p>

<p>Select your main.cpp:
  <input type="file" id="file" name="file" accept=".cpp">
</p>

<button id="upload" onclick="Upload()">Upload</button>