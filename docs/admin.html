<!--Skygear CDN-->
<script src="https://code.skygear.io/js/polyfill/latest/polyfill.min.js"></script>
<script src="https://code.skygear.io/js/skygear/latest/skygear.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

<!--Skygear configuration-->
<!--The app end point and the api key can be found in the developer portal-->
<script>

  skygear.config({
    'endPoint': 'https://cornerch.skygeario.com/', // trailing slash is required
    'apiKey': '93e92fb17bce4768820d623c71ca7b6d',
  }).then(() => {

    console.log('skygear container is now ready for making API calls.');
    Login()
    FetchAll()
    skygear.pubsub.on('upload', (name) => {
      const query = new skygear.Query(Note);
      query.equalTo('name', name)
      skygear.publicDB.query(query)
        .then((records) => {
          const note = records[0]
          CompileSingle(note.name,note.)
        })
    });
  })

  var Login = () => {
    let name = 'Leslie'
    let pw = 'BoyGod'
    console.log('hi')
    skygear.auth.loginWithUsername(name, pw)
      .then((user) => {
        is_login = true
        console.log(user); // user object
      }, (error) => {
        console.error(error);
      })
  }

  var FetchAll = () => {
    const Note = skygear.Record.extend('note');
    const query = new skygear.Query(Note);
    skygear.publicDB.query(query).then((notes) => {
      // notes is an array of Note records that has its "title" equals "First note"
      console.log(notes)
      notes.forEach((note)=>{CompileSingle(note.name,note.attachment.url)})
    }, (error) => {
      console.error(error);
    });
  }

  var CompileSingle = (name, url) => {
    $.ajax({
      url: `/sandbox/compile?name=${name}&cppurl=${url}`,
      success: (data) => {
        skygear.pubsub.publish('feedback', JSON.stringify(data))
      }
    })
  }
</script>